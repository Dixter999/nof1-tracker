---
name: Test fixtures and conftest.py
status: open
created: 2025-12-02T13:25:20Z
updated: 2025-12-03T07:09:09Z
github: https://github.com/Dixter999/nof1-tracker/issues/9
depends_on: [004, 005]
parallel: true
conflicts_with: []
---

# Task: Test fixtures and conftest.py

## Description

Create pytest fixtures and test configuration in conftest.py for the test suite. This includes test database setup, session fixtures with transaction rollback, and sample data factories for testing all database models.

## TDD Requirements

**This project uses Test-Driven Development. You MUST:**
1. ðŸ”´ RED: Write failing tests that use the fixtures
2. ðŸŸ¢ GREEN: Implement fixtures that make tests pass
3. ðŸ”µ REFACTOR: Optimize fixture scopes, add helpers

See `.claude/rules/tdd.enforcement.md` for complete requirements.

## Acceptance Criteria

- [ ] `tests/conftest.py` with fixtures:
  - `test_database_url` - get test DB URL (SQLite for unit tests)
  - `test_engine` - create test database engine
  - `db_session` - session with transaction rollback
  - `reset_db_engine` - reset engine between tests
- [ ] Sample data fixtures:
  - `sample_season` - create test season
  - `sample_llm_model` - create test LLM model
  - `sample_leaderboard_snapshot` - create test snapshot
  - `sample_trade` - create test trade
  - `sample_model_chat` - create test chat
- [ ] Test isolation via transaction rollback
- [ ] Support for both SQLite (fast unit tests) and PostgreSQL (integration)
- [ ] Fixtures documented with docstrings

## Technical Details

### File Location
`tests/conftest.py`

### Fixture Scopes
- `test_database_url`: session scope (same URL for all tests)
- `test_engine`: session scope (one engine per test run)
- `db_session`: function scope (fresh session per test)
- `reset_db_engine`: autouse (runs before each test)

### Test Database Strategy
```python
@pytest.fixture(scope="session")
def test_database_url():
    """Use SQLite for fast unit tests, PostgreSQL for integration."""
    return os.environ.get(
        "TEST_DATABASE_URL",
        "sqlite:///./test_nof1_tracker.db"
    )
```

### Transaction Rollback Pattern
```python
@pytest.fixture(scope="function")
def db_session(test_engine):
    """Create session with automatic rollback after each test."""
    connection = test_engine.connect()
    transaction = connection.begin()
    Session = sessionmaker(bind=connection)
    session = Session()

    yield session

    session.close()
    transaction.rollback()
    connection.close()
```

### Sample Data Factories
```python
@pytest.fixture
def sample_season(db_session):
    """Create a sample season for testing."""
    season = Season(
        season_number=1,
        name="Test Season 1",
        start_date=datetime.utcnow(),
        status="active"
    )
    db_session.add(season)
    db_session.flush()
    return season
```

## Test Cases

1. `test_fixture_db_session_isolation` - changes don't persist between tests
2. `test_fixture_sample_season_created` - season fixture works
3. `test_fixture_sample_llm_model_created` - model fixture works
4. `test_fixture_relationships` - fixtures can create related objects
5. `test_fixture_rollback_on_error` - rollback works on test failure

## Dependencies

- [ ] Task 004: SQLAlchemy models (for model imports)
- [ ] Task 005: Database connection (for reset_engine)
- [ ] External: pytest, pytest-cov

## Effort Estimate

- Size: S
- Hours: 2-3 hours
- Parallel: true (can run alongside 006)

## Definition of Done

- [ ] Tests written FIRST (RED phase) - test the fixtures themselves
- [ ] Code implemented (GREEN phase) - conftest.py complete
- [ ] Code refactored (REFACTOR phase) - optimized scopes
- [ ] All tests passing
- [ ] Test isolation verified
- [ ] Fixtures documented with docstrings
- [ ] `pytest` runs successfully with fixtures
- [ ] Black/Ruff linters pass
