---
name: Alembic migrations setup
status: open
created: 2025-12-02T13:25:20Z
updated: 2025-12-02T13:25:20Z
github: https://github.com/Dixter999/nof1-tracker/issues/8
depends_on: [004, 005]
parallel: false
conflicts_with: []
---

# Task: Alembic migrations setup

## Description

Initialize Alembic for database migrations, configure it to work with SQLAlchemy models, and create the initial migration that establishes all tables. This provides version-controlled database schema management for the project.

## TDD Requirements

**This project uses Test-Driven Development. You MUST:**
1. ðŸ”´ RED: Write failing tests for migration execution
2. ðŸŸ¢ GREEN: Set up Alembic and create initial migration
3. ðŸ”µ REFACTOR: Clean up env.py, add documentation

See `.claude/rules/tdd.enforcement.md` for complete requirements.

## Acceptance Criteria

- [ ] Alembic initialized with `alembic init migrations`
- [ ] `alembic.ini` configured with:
  - Database URL from environment (interpolated)
  - Script location pointing to migrations folder
- [ ] `migrations/env.py` configured to:
  - Import SQLAlchemy models
  - Use target_metadata from Base
  - Support both online and offline modes
- [ ] Initial migration created with all tables:
  - seasons
  - llm_models
  - leaderboard_snapshots
  - trades
  - model_chats
- [ ] `alembic upgrade head` executes successfully
- [ ] `alembic downgrade base` rolls back cleanly
- [ ] Enum types created properly in PostgreSQL

## Technical Details

### Directory Structure
```
migrations/
â”œâ”€â”€ alembic.ini (or at project root)
â”œâ”€â”€ env.py
â”œâ”€â”€ script.py.mako
â”œâ”€â”€ versions/
â”‚   â””â”€â”€ 001_initial_schema.py
â””â”€â”€ init/
    â””â”€â”€ 001_init.sql (Docker entrypoint script)
```

### alembic.ini Configuration
```ini
[alembic]
script_location = migrations
sqlalchemy.url = postgresql://%(NOF1_DB_USER)s:%(NOF1_DB_PASSWORD)s@%(NOF1_DB_HOST)s:%(NOF1_DB_PORT)s/%(NOF1_DB_NAME)s
```

### env.py Modifications
```python
from nof1_tracker.database.models import Base
target_metadata = Base.metadata

# Load .env file
from dotenv import load_dotenv
load_dotenv()
```

### Initial Migration Content
- Create all enum types
- Create all tables with proper columns
- Add indexes
- Add foreign key constraints
- Add unique constraints

## Test Cases

1. `test_alembic_config_valid` - configuration parses correctly
2. `test_alembic_upgrade_head` - migration applies cleanly
3. `test_alembic_downgrade_base` - rollback works
4. `test_tables_created` - all tables exist after migration
5. `test_enum_types_created` - PostgreSQL enums exist
6. `test_indexes_created` - expected indexes present
7. `test_migration_idempotent` - running twice doesn't break

## Dependencies

- [ ] Task 004: SQLAlchemy models (for Base metadata)
- [ ] Task 005: Database connection (for configuration)
- [ ] External: alembic, python-dotenv

## Effort Estimate

- Size: M
- Hours: 3-4 hours
- Parallel: false (depends on 004 and 005)

## Definition of Done

- [ ] Tests written FIRST (RED phase) - tests/test_database/test_migrations.py
- [ ] Code implemented (GREEN phase) - Alembic configured
- [ ] Code refactored (REFACTOR phase) - clean env.py
- [ ] All tests passing
- [ ] `alembic upgrade head` succeeds
- [ ] `alembic downgrade base` succeeds
- [ ] Documentation for running migrations
- [ ] Black/Ruff linters pass on env.py
