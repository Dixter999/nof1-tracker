---
name: Database connection manager
status: open
created: 2025-12-02T13:25:20Z
updated: 2025-12-02T13:25:20Z
github: "[Will be updated when synced to GitHub]"
depends_on: [003, 004]
parallel: false
conflicts_with: []
---

# Task: Database connection manager

## Description

Implement the database connection utilities including engine creation with connection pooling, session management via context manager, and database initialization functions. This provides the interface for all database operations throughout the application.

## TDD Requirements

**This project uses Test-Driven Development. You MUST:**
1. ðŸ”´ RED: Write failing tests for connection and session management
2. ðŸŸ¢ GREEN: Implement connection manager
3. ðŸ”µ REFACTOR: Add error handling, optimize pooling

See `.claude/rules/tdd.enforcement.md` for complete requirements.

## Acceptance Criteria

- [ ] `create_db_engine()` function with:
  - Connection pooling (pool_size, max_overflow from config)
  - pool_pre_ping for connection validation
  - pool_recycle for connection refresh
- [ ] `get_session()` context manager with:
  - Automatic commit on success
  - Automatic rollback on exception
  - Session cleanup on exit
- [ ] `get_session_maker()` for session factory access
- [ ] `init_db()` for table creation (development only)
- [ ] `reset_engine()` for testing/cleanup
- [ ] Singleton pattern for engine (lazy initialization)
- [ ] Thread-safe session management

## Technical Details

### File Location
`src/nof1_tracker/database/connection.py`

### Engine Configuration
```python
create_engine(
    url,
    pool_size=db_settings.pool_size,      # Default: 5
    max_overflow=db_settings.max_overflow, # Default: 10
    pool_pre_ping=True,   # Validate connections
    pool_recycle=3600,    # Recycle after 1 hour
)
```

### Session Context Manager
```python
@contextmanager
def get_session() -> Generator[Session, None, None]:
    session = session_maker()
    try:
        yield session
        session.commit()
    except Exception:
        session.rollback()
        raise
    finally:
        session.close()
```

### Module Exports
Update `src/nof1_tracker/database/__init__.py` to export:
- db_settings, DatabaseSettings
- get_session, get_session_maker, init_db, reset_engine
- Base, Season, LLMModel, LeaderboardSnapshot, Trade, ModelChat

## Test Cases

1. `test_create_db_engine` - engine creation with config
2. `test_session_context_manager_commit` - auto-commit on success
3. `test_session_context_manager_rollback` - auto-rollback on exception
4. `test_session_cleanup` - session closed after use
5. `test_engine_singleton` - same engine returned on multiple calls
6. `test_reset_engine` - engine reset works correctly
7. `test_init_db` - tables created successfully

## Dependencies

- [ ] Task 003: Pydantic configuration (for db_settings)
- [ ] Task 004: SQLAlchemy models (for Base, models)
- [ ] External: sqlalchemy

## Effort Estimate

- Size: S
- Hours: 2-3 hours
- Parallel: false (depends on 003 and 004)

## Definition of Done

- [ ] Tests written FIRST (RED phase) - tests/test_database/test_connection.py
- [ ] Code implemented (GREEN phase) - connection.py complete
- [ ] Code refactored (REFACTOR phase) - clean error handling
- [ ] All tests passing
- [ ] Type hints complete
- [ ] Docstrings for all functions
- [ ] Black/Ruff linters pass
- [ ] mypy type checking passes
- [ ] __init__.py exports all public symbols
