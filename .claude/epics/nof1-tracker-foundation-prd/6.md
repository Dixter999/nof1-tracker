---
name: SQLAlchemy ORM models
status: open
created: 2025-12-02T13:25:20Z
updated: 2025-12-03T06:20:16Z
github: https://github.com/Dixter999/nof1-tracker/issues/6
depends_on: [001]
parallel: true
conflicts_with: []
---

# Task: SQLAlchemy ORM models

## Description

Implement SQLAlchemy ORM models for storing Alpha Arena trading data. This includes models for Season, LLMModel, LeaderboardSnapshot, Trade, and ModelChat entities with proper relationships, constraints, and PostgreSQL-specific features like JSONB.

## TDD Requirements

**This project uses Test-Driven Development. You MUST:**
1. ðŸ”´ RED: Write failing tests for model creation and relationships
2. ðŸŸ¢ GREEN: Implement all SQLAlchemy models
3. ðŸ”µ REFACTOR: Add indexes, optimize relationships

See `.claude/rules/tdd.enforcement.md` for complete requirements.

## Acceptance Criteria

- [ ] `Season` model with:
  - Fields: id, season_number, name, start_date, end_date, initial_capital, status
  - Enum: season_status (active, completed, cancelled)
  - Relationship to LeaderboardSnapshot
- [ ] `LLMModel` model with:
  - Fields: id, name, provider, model_id, is_active
  - Relationships to LeaderboardSnapshot, Trade, ModelChat
- [ ] `LeaderboardSnapshot` model with:
  - Fields: id, season_id, model_id, timestamp, rank, total_assets, pnl, pnl_percent, roi, win_rate, total_trades, raw_data
  - JSONB field for raw_data
  - Unique constraint on (model_id, timestamp)
- [ ] `Trade` model with:
  - Fields: id, model_id, trade_id, symbol, side, entry_price, exit_price, size, leverage, pnl, pnl_percent, status, opened_at, closed_at, raw_data
  - Enums: trade_side, trade_status
- [ ] `ModelChat` model with:
  - Fields: id, model_id, timestamp, content, decision, symbol, confidence, raw_data
  - Enum: chat_decision
- [ ] All models have created_at/updated_at timestamps
- [ ] Proper indexes on frequently queried columns
- [ ] __repr__ methods for debugging

## Technical Details

### File Location
`src/nof1_tracker/database/models.py`

### PostgreSQL Specific Features
- JSONB for raw_data columns
- Custom ENUM types (avoid SQLAlchemy native enums for better PostgreSQL compatibility)
- Numeric precision: Decimal(15,2) for USD, Decimal(20,8) for crypto prices

### Indexes
- season_number (unique)
- model name (unique)
- model_id on LeaderboardSnapshot, Trade, ModelChat
- timestamp on LeaderboardSnapshot, Trade, ModelChat
- trade_id (unique)
- symbol on Trade

### Relationships
```
Season 1--* LeaderboardSnapshot
LLMModel 1--* LeaderboardSnapshot
LLMModel 1--* Trade
LLMModel 1--* ModelChat
```

## Test Cases

1. `test_season_creation` - create season with all fields
2. `test_llm_model_creation` - create model with provider
3. `test_leaderboard_snapshot_creation` - create snapshot with FK
4. `test_leaderboard_snapshot_unique_constraint` - verify uniqueness
5. `test_trade_creation` - create trade with enums
6. `test_model_chat_creation` - create chat with decision
7. `test_model_relationships` - verify relationship navigation
8. `test_jsonb_field` - store and retrieve JSONB data

## Dependencies

- [ ] Task 001: Project scaffolding (for package structure)
- [ ] External: sqlalchemy, psycopg2-binary

## Effort Estimate

- Size: M
- Hours: 4-5 hours
- Parallel: true (can run alongside 003)

## Definition of Done

- [ ] Tests written FIRST (RED phase) - tests/test_database/test_models.py
- [ ] Code implemented (GREEN phase) - models.py complete
- [ ] Code refactored (REFACTOR phase) - optimized indexes
- [ ] All tests passing
- [ ] Type hints complete
- [ ] Docstrings for all classes
- [ ] Black/Ruff linters pass
- [ ] mypy type checking passes
